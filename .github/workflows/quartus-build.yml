name: JVS Submodule Quartus Compilation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quartus-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libc6-i386 lib32z1 lib32ncurses6 libbz2-1.0 libxext6 libxft2 libxi6 libxtst6
    
    - name: Install Quartus Prime Lite
      run: |
        # Download and install Quartus Lite
        wget -q https://downloads.intel.com/akdlm/software/acdsinst/24.1std/1077/qinst/qinst-lite-linux-24.1std-1077.run
        chmod +x qinst-lite-linux-24.1std-1077.run
        
        # Extract and install automatically
        ./qinst-lite-linux-24.1std-1077.run --accept --quiet --nox11 --target $HOME/quartus_temp
        
        # Run the installer with help to see options
        cd $HOME/quartus_temp
        ./qinst.sh --help || true
        
        # Try different installation approach
        ./qinst.sh --cli || ./qinst.sh
        
        # Find Quartus installation
        find $HOME -name "quartus_sh" -type f 2>/dev/null || echo "quartus_sh not found"
        
        # Set PATH based on found installation
        if [ -f "$HOME/quartus_temp/quartus/bin/quartus_sh" ]; then
          echo "$HOME/quartus_temp/quartus/bin" >> $GITHUB_PATH
        elif [ -f "$HOME/quartus_temp/intelFPGA_lite/24.1/quartus/bin/quartus_sh" ]; then
          echo "$HOME/quartus_temp/intelFPGA_lite/24.1/quartus/bin" >> $GITHUB_PATH
        fi
    
    - name: Compile JVS project
      run: |
        # Find and verify Quartus installation
        QUARTUS_PATH=$(find $HOME -name "quartus_sh" -type f 2>/dev/null | head -1)
        if [ -z "$QUARTUS_PATH" ]; then
          echo "❌ quartus_sh not found"
          exit 1
        fi
        
        echo "✅ Found quartus_sh at: $QUARTUS_PATH"
        ls -la "$QUARTUS_PATH"
        
        # Run compilation
        "$QUARTUS_PATH" --flow compile jvs
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jvs-quartus-outputs
        path: |
          output_files/
          *.rpt
          *.summary
        retention-days: 30
    
    - name: Check compilation result
      run: |
        if [ -f "output_files/jvs.rbf" ]; then
          echo "✅ JVS compilation successful"
        else
          echo "❌ JVS compilation failed"
          exit 1
        fi